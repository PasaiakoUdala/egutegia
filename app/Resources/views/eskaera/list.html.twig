{% extends 'base.html.twig' %}

{% block headline %}{{ 'Eskaeren zerrenda' | trans }} {% endblock %}

{% block content_row %}

    <div class="row">
        <div class="col-md-2">
            <div id="toolbar">
                <div class="btn-group" role="group" aria-label="...">
                    <a class="btn btnZabaldu btn-default" href="javascript:void(0);">{{ 'Zabaldu' | trans }}</a>
                </div>
            </div>
        </div>
        <div class="col-md-10">
            <div class="btn-group" role="group" aria-label="...">
                <a class="btn {% if app.request.get('q') == 'all' %}        btn-info {% else %} btn-default {% endif %}"
                   href="{{ path('admin_eskaera_list', { 'q': 'all'}) }}">{{ 'Guztiak' | trans }}</a>
                <a class="btn {% if app.request.get('q') == 'no-way' %}     btn-info {% else %} btn-default {% endif %}"
                   href="{{ path('admin_eskaera_list', { 'q': 'no-way'}) }}">{{ 'Bideratu gabeak' | trans }}</a>
                <a class="btn {% if app.request.get('q') == 'unsigned' %}   btn-info {% else %} btn-default {% endif %}"
                   href="{{ path('admin_eskaera_list', { 'q': 'unsigned'}) }}">{{ 'Gauzatu gabeak' | trans }}</a>
                <a class="btn {% if app.request.get('q') == 'unadded' %}    btn-info {% else %} btn-default {% endif %}"
                   href="{{ path('admin_eskaera_list', { 'q': 'unadded'}) }}">{{ 'Egutean sartu gabe' | trans }}</a>
                <a class="btn {% if app.request.get('q') == 'conflict' %}    btn-info {% else %} btn-default {% endif %}"
                   href="{{ path('admin_eskaera_list', { 'q': 'conflict'}) }}">{{ 'Bateraezinak' | trans }}</a>
            </div>

        </div>
    </div>
    <div class="row">&nbsp;</div>
    <div class="row">
        <div class="col-md-4"></div>
        <div class="col-md-4">
            <div id="flash">
                {% if app.session.started %}
                    {% for label, flashes in app.session.flashbag.all %}
                        {% for flash in flashes %}
                            <div class="alert alert-{{ label }}">
                                {{ flash }}
                            </div>
                        {% endfor %}
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        <div class="col-md-4"></div>
    </div>
    <div class="row">&nbsp;</div>
    <div class="row">

        <div class="col-md-12">
            <table id="tableEskaerak"
                   data-toggle="table"
                   data-classes="table table-hover table-condensed"
                   data-striped="true"
                   data-id-field="id"
                   data-pagination="true"
                   data-page-size="15"
                   data-search="true"
                   data-sort-name="id"
                   data-sort-order="desc"
                   data-icon-size="sm"
                   data-show-refresh="true"
                   data-show-toggle="true"
                   data-show-columns="true"
                   data-toolbar="#toolbar"

                   data-row-style="rowStyle"

                   data-show-export="true"
                   data-export-types="['csv','excel', 'pdf']"
                   data-export-options='{
                     "fileName": "export",
                     "worksheetName": "export",
                     "jspdf": {
                       "autotable": {
                         "styles": { "rowHeight": 20, "fontSize": 10 },
                         "headerStyles": { "fillColor": 255, "textColor": 0 },
                         "alternateRowStyles": { "fillColor": [60, 69, 79], "textColor": 255 }
                       }
                     }
                   }'
                   data-detail-view="true"
                   data-detail-formatter="detailFormatter"
            >
                <thead>
                <tr>
                    <th data-visible="false" data-halign="center" data-align="left" data-field="id" data-sortable="true">ID</th>
                    <th data-visible="false" data-halign="center" data-align="left" data-field="eskaera.emaitza" data-sortable="true">Emaitza</th>
                    <th data-halign="center" data-align="left" data-field="eskaera.name" data-sortable="true">{{ "Izaera" | trans }}</th>
                    {#<th data-halign="center" data-align="left" data-field="eskaera.user.department" data-sortable="true">{{ "Saila" | trans }}</th>#}
                    <th data-halign="center" data-align="left" data-field="eskaera.type.name " data-sortable="true">{{ "Mota" | trans }}</th>
                    {#<th data-halign="center" data-align="center" data-field="eskaera.noiz" data-sortable="true">{{ "table.eskaera" | trans }}</th>#}
                    <th data-halign="center" data-align="left" data-field="eskaera.hasi" data-sortable="true">{{ "Hasi" | trans }}</th>
                    <th data-halign="center" data-align="left" data-field="eskaera.amaitu" data-sortable="true">{{ "Amaitu" | trans }}</th>
                    <th data-halign="center" data-align="left" data-field="eskaera.orduak" data-sortable="true">{{ "Orduak" | trans }}</th>
                    <th data-halign="center" data-align="center" data-field="eskaera.abiatua" data-sortable="false">{{ "Bideratua" | trans }}</th>
                    <th data-halign="center" data-align="center" data-field="eskaera.amaitua" data-sortable="false">{{ "Gauzatua" | trans }}</th>
                    <th data-halign="center" data-align="center" data-field="eskaera.egutegian" data-sortable="false">{{ "Egutegian" | trans }}</th>
                    <th data-halign="center" data-align="center" data-field="eskaera.sinatzaileak" data-sortable="false">{{ "Sinatzaile taldea" | trans }}</th>
                    <th data-halign="center" data-align="center" data-field="eskaera.konfliktoa" data-sortable="false">{{ "Bateraezinak" | trans }}</th>
                    <th data-halign="center" data-align="center" data-field="eskaera.oharrak" data-sortable="false">{{ "Oharrak" | trans }}</th>
                    <th>{{ "Ekintzak" | trans }}</th>
                </tr>
                </thead>
                <tbody>
                {% for eskaera in eskaeras %}
                    <tr>
                        <td>{{ eskaera.id }}</td>
                        <td>{{ eskaera.emaitza }}</td>
                        <td>
                            <a href="{{ path('admin_calendar_edit', { 'id': eskaera.calendar.id }) }}" class="btnEskaera" data-id="{{ eskaera.id }}">
                                {{ eskaera.name }}
                            </a>
                        </td>
                        {#<td>#}
                            {#<span data-html="true" data-toggle="tooltip" data-placement="top" title="{{ eskaera.user.department }}">#}
                                {#{{ eskaera.user.department |length > 10 ? eskaera.user.department |slice(0, 10) ~ '...' : eskaera.user.department }}#}
                            {#</span>#}
                        {#</td>#}
                        <td>
                            <span data-html="true" data-toggle="tooltip" data-placement="top" title="{{ eskaera.type.name }}">
                                {{ eskaera.type.name |length > 10 ? eskaera.type.name |slice(0, 10) ~ '...' : eskaera.type.name }}
                            </span>
                        </td>
                        <td>{{ eskaera.hasi | date('Y-m-d') }}
                            {#{% if eskaera.noiz %}#}
                                {#<label class="label label-default" data-html="true" data-toggle="tooltip" data-placement="top"#}
                                       {#title="Hasi: {{ eskaera.hasi|date('Y-m-d') }} <br/>Amaitu: {{ eskaera.amaitu|date('Y-m-d') }} <br />Orduak: {{ eskaera.orduak }}">#}
                                    {#{{ eskaera.noiz|date('Y-m-d') }}#}
                                {#</label>#}
                            {#{% endif %}#}
                        </td>
                        <td>{{ eskaera.amaitu | date('Y-m-d') }}</td>
                        <td>{{ eskaera.total }}</td>
                        <td>
                            <a href="javascript:void(0);" class="btnEskaera" data-id="{{ eskaera.id }}">
                                {% if eskaera.abiatua == true %}
                                    <label class="label label-success">Bai</label>
                                {% else %}
                                    <label class="label label-danger">Ez</label>
                                {% endif %}
                            </a>
                        </td>
                        <td>
                            <a href="javascript:void(0);" class="btnEskaera" data-id="{{ eskaera.id }}">
                                {% if eskaera.amaitua == true %}
                                    <label class="label label-success">Bai</label>
                                {% else %}
                                    <label class="label label-danger">Ez</label>
                                {% endif %}
                            </a>
                        </td>
                        <td>
                            {% if eskaera.amaitua == true %}
                                <a href="javascript:void(0);" class="btnEskaeraEgutegira" data-id="{{ eskaera.id }}"
                                   data-egutegian="{{ eskaera.egutegian }}">
                                    {% if eskaera.egutegian == true %}
                                        <label class="label label-success">Bai</label>
                                    {% else %}
                                        <label class="label label-danger">Ez</label>
                                    {% endif %}
                                </a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if eskaera.sinatzaileak %}
                                <a href="{{ path('admin_sinatzaileak_show', { 'id': eskaera.sinatzaileak.id} ) }}"
                                   target="_blank">{{ eskaera.sinatzaileak }}</a>
                            {% else %}
                                Bideratu gabe.
                            {% endif %}

                        </td>

                        <td>
                            {% if eskaera.konfliktoa == true %}
                                <label class="label label-danger">Bai</label>
                            {% else %}
                                <label class="label label-success">Ez</label>
                            {% endif %}
                        </td>

                        <td>
                            <span data-html="true" data-toggle="tooltip" data-placement="top" title="{{ eskaera.oharra }}">
                                {{ eskaera.oharra|length > 10 ? eskaera.oharra|slice(0, 10) ~ '...' : eskaera.oharra }}
                            </span>
                        </td>

                        <td>
                            <ul class="list text-left">
                                <li>
                                    <a href="{{ path('eskaera_show', { 'id': eskaera.id }) }}" target="_blank">
                                        <i class="fa fa-eye" aria-hidden="true"></i> {{ "Ikusi" | trans }}
                                    </a>
                                </li>
                                {% if eskaera.egutegian == false %}
                                    <li>
                                        {{ form_start(deleteForms[eskaera.id],{'attr': {'id': eskaera.id}}) }}
                                        <a class="btnRemoveRow" data-id="{{ eskaera.id }}"
                                           href="#eskaeraEditModal{{ eskaera.id }}">
                                            <i class="fa fa-trash text-danger" aria-hidden="true"></i> {{ "Ezabatu" | trans }}
                                        </a>
                                        {{ form_end(deleteForms[eskaera.id]) }}
                                    </li>
                                {% endif %}
                                {% if eskaera.amaitua != true %}
                                    <li>
                                        {% if eskaera.bideratua %}
                                            <i class="fa fa-paper-plane" aria-hidden="true"></i>
                                        {% else %}
                                            <a href="javascript:void(0);" class="btnEskaera" data-id="{{ eskaera.id }}"
                                               data-myURL="{{ path('admin_eskaera_edit', {'id': eskaera.id}) }}">
                                                <i class="fa fa-paper-plane" aria-hidden="true"></i> {{ "Bideratu" | trans }}
                                            </a>
                                        {% endif %}

                                    </li>
                                {% endif %}
                                {#BIDERATUA ETA GAUZATUA BADAGO,EGUTEGIAN GEHITZEKO AUKERA EMAN#}

                                {% if eskaera.amaitua and eskaera.emaitza == true  %}

                                    <li>
                                        <a href="javascript:void(0);" class="btnEskaeraEgutegira"
                                           data-id="{{ eskaera.id }}" data-egutegian="{{ eskaera.egutegian }}">
                                            <i class="fa fa-calendar-check-o" aria-hidden="true"></i>
                                        </a>
                                    </li>


                                {% endif %}


                            </ul>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="6"> Ez dago daturik</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>

    <div class="my-modal-base">
        <div class="my-modal-cont"></div>
    </div>

{% endblock %}

{% block foot_script %}
    {{ parent() }}
    <script>
        var $table = $("#tableEskaerak");

        $(document).ready(function () {

            $("[data-toggle=\"tooltip\"]").tooltip();

            $("input[name*='appbundle_eskaera[hasi]']").datepicker({
                autoclose: true,
                format: "yyyy-mm-dd",
                language: "eu"
            });
            $("input[name*='appbundle_eskaera[noiz]']").datepicker({
                autoclose: true,
                format: "yyyy-mm-dd",
                language: "eu"
            });
            $("input[name*='appbundle_eskaera[amaitu]").datepicker({
                autoclose: true,
                format: "yyyy-mm-dd",
                language: "eu"
            });

            $("#flash").delay(500).fadeIn("normal", function () {
                $(this).delay(2500).fadeOut();
            });

            $(".btnEskaeraEgutegira").on("click", function () {

                var egutegian = $(this).data("egutegian");

                if ( egutegian === 1 ) {
                    return bootbox.alert({
                        message: "Iadanik egutegian grabatua daude datu hauek.",
                        className: "bb-alternate-modal"
                    });
                }

                var miid = $(this).data("id");

                bootbox.confirm({
                    title: "Seguru zuaude?",
                    message: "Onartu botoian klik egin ondoren eskaera hau langilearen egutegian gehituko da. Ados? <br /> Horrez gain eskaera dokumentua ere itsatsiko da.",
                    buttons: {
                        cancel: {
                            label: "<i class=\"fa fa-times\"></i> Ezeztatu"
                        },
                        confirm: {
                            label: "<i class=\"fa fa-check\"></i> Onartu"
                        }
                    },
                    callback: function ( result ) {
                        if ( result === true ) {
                            window.location.href = Routing.generate("eskaera_add_to_calendar", { "id": miid }, true);
                        }

                    }
                });
            });

            $(".btnEskaera").on("click", function () {
                var url = $(this).data("myurl");
                $(".my-modal-cont").load(url, function () {
                    $("#myModal").modal({ show: true });
                });
            });

            $table.bootstrapTable();
            $table.on("expand-row.bs.table", function ( e, index, row, $detail ) {
                var miid = row.id;
                var url = Routing.generate("get_firmatzaileak", { "eskaeraid": miid });

                $detail.html("toc toc..." + url + " helbideari deika");

                $.get(url, function ( data ) {
                    var html = "<div class='row'>" +
                        "<div class='col-md-2'></div>" +
                        "<div class='col-md-8'>" +
                        "<table class='table table-bordered table-striped table-hover table-condensed'>" +
                        "<thead>" +
                        "       <tr>" +
                        "           <th><strong>Orden</strong></th>" +
                        "           <th><strong>Langilea</strong></th>" +
                        "           <th><strong>Firmatua</strong></th>" +
                        "           <th><strong>Erantzuna</strong></th>" +
                        "           <th><strong></strong></th>" +
                        "       </tr>" +
                        "   </thead>" +
                        "<tbody>";
                    $.each(data, function ( i, obj ) {
                        var jakinarazpenid = 0;
                        var postit = false;
                        var autofirma = false;

                        if ( "postit" in obj ) {
                            postit = true;
                        }

                        if ( "autofirma" in obj ) {
                            autofirma = true;
                        }

                        /** bilatu jakinarazpen_id **/
                        $.each(obj.notify, function ( k, n ) {
                            if ( n.user.id === obj.user.id ) {
                                jakinarazpenid = n.id;
                                return false;
                            }
                        });

                        var nireOrdena = parseInt(obj.ordena);
                        nireOrdena = nireOrdena + 1;

                        html = html + "<tr'><td>" + nireOrdena + "</td>";
                        html = html + "<td>" + obj.user.username + "</td>";
                        var sinatua = false;

                        /** Null baldin bada ez duelako firmatu. Firmatzean, 0 edo 1 sartzen da, erantzunaren arabera */
                        if ( !("firmatua" in obj) ) {
                            html = html + "<td><span class='label label-warning '>Ez</span></td><td>-</td>";
                        } else {
                            html = html + "<td><span class='label label-success '>Bai</span></td>";

                            if ( obj.firmatua === true ) {
                                sinatua = true;
                                html = html + "<td><span class='label label-success'>Bai onartua</span></td>";
                            } else {
                                html = html + "<td><span class='label label-danger'>Ez onartua</span></td>";
                            }
                        }

                        /** Sinadura badu ez du postit botoia behar */
                        if ( sinatua === false ) {
                            html = html + "<td>" +
                                "<button class='btn btn-xs btn-primary btnPostIt' data-firmaid=" + obj.firmaid + " data-userid=" + obj.user.id + " data-notifyid=" + jakinarazpenid + ">Post it!</button>" +
                                "</td>";
                        } else {
                            if ( postit === true ) {
                                html = html + "<td>Postit botoi bidez sinatua</td>";
                            } else if ( autofirma === true ) {
                                html = html + "<td>Autofirmatua</td>";
                            } else {
                                html = html + "<td></td>";
                            }
                        }

                        html = html + "</tr>";


                    });


                    html = html + "</tbody></table>" +
                        "<div class='col-md-2'></div>" +
                        "</div>";


                    $detail.html(html);
                }).fail(function () {
                    bootbox.alert({
                        message: "Akats bat gertatu da. Agian eskaera bideratu gabe dago?",
                        className: "bb-alternate-modal",
                        backdrop: true
                    });
                    $detail.html("");
                });
            });

            $(".saveEditModal").on("click", function () {
                var miid = $(this).data("id");
                var mifrm = $("#frmEditEskaera" + miid);
                $(mifrm).submit();
            });

            $(".btnRemoveRow").on("click", function () {
                var that = $(this);
                bootbox.confirm({
                    title: "{{ 'Adi!' | trans }}",
                    message: "{{ 'msg.eskaera.ezabatu' | trans }}",
                    buttons: {
                        cancel: {
                            label: '<i class="fa fa-times"></i> {{ 'Ezeztatu' | trans }}'
                        },
                        confirm: {
                            label: '<i class="fa fa-check"></i> {{ 'Onartu' | trans }}'
                        }
                    },
                    callback: function ( result ) {
                        if ( result === true ) {
                            $(that).closest("form").submit();
                        }
                    }
                });
            });

            $("#tableEskaerak").on("click", ".btnPostIt", function () {
                var userid = $(this).data("userid");
                var firmaid = $(this).data("firmaid");
                var jakinarazpenaid = $(this).data("notifyid");
                var url = Routing.generate("put_postit", { id: firmaid, userid: userid });

                bootbox.prompt({
                    title: "Oharra",
                    inputType: "textarea",
                    callback: function ( result ) {
                        console.log(result);
                        if ( result !== null ) {
                            $.ajax({
                                url: url,
                                method: "PUT",
                                data: { onartua: 1, oharra: result }
                            })
                             .done(function () {
                                 var url2 = Routing.generate("put_jakinarazpena", { "id": jakinarazpenaid });
                                 $.ajax({
                                     url: url2,
                                     method: "PUT",
                                     data: { onartua: 1 }
                                 }).done(function () {
                                     location.reload();
                                 }).fail(function () {
                                     bootbox.alert("Firma egin da baina jakinarazpena irakurria markatzerakoan akatsa bat gertatu da.");
                                 });
                             })
                             .fail(function () {
                                 bootbox.alert("Akats bat gertatu da firmatzerakoan.");
                             });
                        }

                    }
                });


            });



        });
    </script>
    <script>
        // HACK!
        $(document).ready(function () {
            $(".btnZabaldu").on("click", function () {
                $(".detail-icon").trigger("click");
            });
        });
    </script>

{% endblock %}
