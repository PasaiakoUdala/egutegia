{% extends 'base.html.twig' %}

{% block head_style %}

    {{ parent() }}
    <style>
        .datepicker table tr td.disabled,
        .datepicker table tr td.disabled:hover {
            color: #b90000;
        }
    </style>

{% endblock %}

{% block headline %}{{ eskaera.type.name ~ ' ' ~ 'eskaera berria' | trans  | lower }} {% endblock %}

{% block content_row %}
    <div class="row">
        <div class="col-md-1"></div>
        <div class="col-md-10">
            {{ form_start(form, { 'attr': {'class': 'form-horizontal', 'id': 'frmEskaeraNew'} }) }}

            <div class="form-group">
                <label for="min-date" class="col-sm-4 control-label">{{ 'Noiztik' | trans }}</label>
                <div class="col-sm-7">
                    {{ form_widget(form.hasi, { 'attr': {'class': 'form-control cmbFetxaKalc', 'autocomplete': 'null'} }) }}
                </div>
            </div>

            <div class="form-group">
                <label for="min-date" class="col-sm-4 control-label">{{ 'Noiz arte' | trans }}</label>
                <div class="col-sm-7">
                    {{ form_widget(form.amaitu, { 'attr': {'class': 'form-control cmbFetxaKalc', 'autocomplete': 'null'} }) }}
                </div>
            </div>

            <div class="form-group">
                <label for="min-date" class="col-sm-4 control-label">{{ 'Eskatutako <strong>egunak</strong>' | trans|raw }}</label>
                <div class="col-sm-4">
                    {{ form_widget(form.egunak, { 'attr': {'class': 'form-control'} }) }}
                </div>
                <div class="col-sm-3">
                    <p class="">Dituzun egunak: {{ (calendar.hoursSelf / calendar.hoursDay) | round (2) }} egun ( {{ calendar.hoursSelf }} ordu ) </p>
                </div>
            </div>

            <div class="form-group">
                <label for="min-date" class="col-sm-4 control-label">{{ 'Eskatutako <strong>orduak</strong>' | trans | raw }}</label>
                <div class="col-sm-4">
                    {{ form_widget(form.orduak, { 'attr': {'class': 'form-control cmbFetxaKalc'} }) }}
                </div>
                <div class="col-sm-3">
                    <p class="">Dituzun egunak: {{ (calendar.hoursSelfHalf / calendar.hoursDay) | round (2) }} egun ( {{ calendar.hoursSelfHalf }} ordu ) </p>
                </div>
            </div>

            <div class="form-group">
                <div class="col-md-4"></div>
                <div class="col-md-8">
                    <p>{{ 'Lanaldia' | trans }}: {{ eskaera.calendar.hoursDay }}</p>
                </div>
            </div>

            <div class="form-group">
                <label for="min-date" class="col-sm-4 control-label">{{ 'Guztira zenbat <strong>ordu</strong>' | trans | raw }}</label>
                <div class="col-sm-7">
                    {{ form_widget(form.total, { 'attr': {'class': 'form-control disabled'} }) }}
                </div>
            </div>

            <div class="form-group">
                {% if 'KONPENTSA' not in eskaera.type.name | upper %}
                    <label for="appbundle_eskaera_oharra" class="col-sm-4 control-label">{{ 'Deskribapena' | trans }}</label>
                {% else %}
                    <label for="appbundle_eskaera_oharra" class="col-sm-4 control-label">{{ 'Azalpena' | trans }}</label>
                {% endif %}
                <div class="col-sm-7">
                    {{ form_widget(form.oharra, { 'attr': {'class': 'form-control'} }) }}
                </div>
            </div>


            <div class="form-group">
                <label for="min-date" class="col-sm-4 control-label">{{ 'Eskaera data' | trans }}</label>
                <div class="col-sm-7">
                    {{ form_widget(form.noiz, { 'attr': {'class': 'form-control'} }) }}
                </div>
            </div>

            <div class="form-group">
                <div class="col-md-4"></div>
                <div class="col-md-4">
                    <button id="btnSubmit" type="button" class="btn btn-primary">{{ 'Eskaera gauzatu' | trans }}</button>
                </div>
                <div class="col-md-4"></div>
            </div>
            <div style="display: none">
                {{ form_end(form) }}
                <input id="txtJornada" type="text" value="{{ calendar.getHoursDay }}">
                <input id="hoursFree" type="text" value="{{ calendar.hoursFree }}">
                <input id="eskaeramota" type="hidden" value="{{ eskaera.type.name }}">
            </div>

        </div>
        <div class="col-md-1"></div>
    </div>


    <input type="hidden" id="txtJaiEgunak" value="{{ jaiegunak |  serialize('json') }}" />

{% endblock %}

{% block foot_script %}
    {{ parent() }}
    <script language="JavaScript">
        $("#btnSubmit").on("click", function () {
            var ongi = true;
            var eskaeramota = $("#eskaeramota").val();
            var konpentsatuada = false;
            if ( eskaeramota.toUpperCase().indexOf("KONPENTSA") !== -1 ) {
                konpentsatuada = true;
            }

            if ( $("input[type=radio]:checked").length === 0 ) {
                bootbox.alert("Mota zehaztea beharrezkoa da.");
                ongi = false;
                return;
            }

            var hasi = $("input[name='appbundle_eskaera[hasi]']").val();
            if ( hasi.length === 0 ) {
                if ( konpentsatuada === false ) {
                    bootbox.alert("Noiztik zehaztea beharrezkoa da.");
                } else {
                    bootbox.alert("Eguna zehaztea beharrezkoa da.");
                }

                ongi = false;
                return;
            }

            if ( konpentsatuada === false ) {
                var amaitu = $("input[name='appbundle_eskaera[amaitu]']").val();
                if ( amaitu.length === 0 ) {
                    bootbox.alert("Amaitu zehaztea beharrezkoa da.");
                    ongi = false;
                    return;
                }

                var egunak = $("input[name='appbundle_eskaera[egunak]']").val();
                if ( egunak.length === 0 ) {
                    bootbox.alert("Egunak zehaztea beharrezkoa da.");
                    ongi = false;
                    return;
                }
            } else {
                var oharra = $("input[name='appbundle_eskaera[oharra]']").val();
                if ( oharra.length === 0 ) {
                    bootbox.alert("Azalpena zehaztea beharrezkoa da.");
                    ongi = false;
                    return;
                }
            }


            var orduak = $("input[name='appbundle_eskaera[orduak]']").val();
            if ( orduak.length === 0 ) {
                bootbox.alert("Orduak zehaztea beharrezkoa da.");
                ongi = false;
                return;
            }
            var noiz = $("input[name='appbundle_eskaera[noiz]']").val();
            if ( noiz.length === 0 ) {
                bootbox.alert("Noiz zehaztea beharrezkoa da.");
                ongi = false;
                return;
            }


            if ( ongi ) {
                $("#frmEskaeraNew").submit();
            }


        });

        var jaiegunak = JSON.parse($("#txtJaiEgunak").val());
        var arrayJaiEgunak = [];

        $.each(jaiegunak, function ( key, value ) {
            var nireFetxa = moment(value.start_date);
            arrayJaiEgunak.push(moment(nireFetxa).format("YYYY-MM-DD"));
        });

        $("#appbundle_eskaera_hasi").datepicker({
            autoclose: true,
            format: "yyyy-mm-dd",
            datesDisabled: arrayJaiEgunak,
            daysOfWeekDisabled: "6,0",
            language: '{{ app.request.locale }}'
        });

        $("#appbundle_eskaera_amaitu").datepicker({
            autoclose: true,
            format: "yyyy-mm-dd",
            datesDisabled: arrayJaiEgunak,
            daysOfWeekDisabled: "6,0",
            language: '{{ app.request.locale }}'
        });

        $("#appbundle_eskaera_noiz").datepicker({
            autoclose: true,
            format: "yyyy-mm-dd",
            datesDisabled: arrayJaiEgunak,
            daysOfWeekDisabled: "6,0",
            language: '{{ app.request.locale }}'
        });

        function workday_count( fstart, fend ) {
            var start = moment(fstart);
            var end = moment(fend);
            var first = start.clone().endOf("week"); // end of first week
            var last = end.clone().startOf("week"); // start of last week
            var days = Math.floor(last.diff(first, "days") * 5 / 7); // this will always multiply of 7

            var wfirst = first.day() - start.day(); // check first week
            if ( start.day() === 0 ) --wfirst; // -1 if start with sunday

            var wlast = end.day() - last.day(); // check last week
            if ( end.day() === 6 ) --wlast; // -1 if end with saturday

            return wfirst + days + wlast - kendu_jai_egunak(fstart, fend); // get the total
        }

        function kendu_jai_egunak( fstart, fend ) {
            /** Funtzio onek fstart eta fend artean loop bat egin eta jai eguna den begiratzen du
             * uneko eguna arrayJaiEgunak Array-ean dagoen begiratuz, beti ere asteburua ez denean.
             *
             * Zenbat egun topatu diren itzultzen du
             */
            var a = moment(fstart);
            var b = moment(fend);
            var erantzuna = 0;
            for ( var m = moment(a); m.diff(b, 'days') <= 0; m.add(1, "days") ) {

                if ( (m.weekday() !== 6) && (m.weekday() !== 0) ) {
                    if ( jQuery.inArray(m.format("YYYY-MM-DD"), arrayJaiEgunak) !== -1 ) {
                        erantzuna += 1;
                    }

                }
            }

            return erantzuna;
        }


        $(".cmbFetxaKalc").change(function () {
            $("#appbundle_eskaera_total").val(0);
            const txtEgunak = $("#appbundle_eskaera_egunak").val();
            var d;
            if ( txtEgunak === "0" ) {
                d = 0;
                // return
            } else {
                const hasi = $("#appbundle_eskaera_hasi").val();
                const amaitu = $("#appbundle_eskaera_amaitu").val();
                d = workday_count(hasi, amaitu);
                if ( isNaN(d) ) {
                    d = 0;
                }
            }

            const orduak = $("#appbundle_eskaera_orduak").val();
            const egunOrduak = $("#txtJornada").val();

            $("#appbundle_eskaera_egunak").val(d.toFixed(2));
            var tmp = $("#appbundle_eskaera_egunak").val() * egunOrduak;

            tmp = parseFloat(tmp) + parseFloat(orduak);

            $("#appbundle_eskaera_total").val(tmp.toFixed(2));

        });

    </script>
{% endblock %}


